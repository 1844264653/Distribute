### 第二章  单机存储系统

**单机存储引擎就是哈希表，B树等数据结构在机械磁盘，SSD等持久化介质上的实现**（**哈希存储引擎**是**哈希表的持久化实现**，**B树存储引擎**是**B树的持久化实现**，**LSM[Log Structure Merge Tree]树存储引擎采用批量转存储技术来避免磁盘随机写入**）

单机存储系统是单机存储引擎的一种封装，对外提供文件、键值，表格或者关系模型

单机存储系统的理论来源于关系数据库。

**数据库将一个或者多个操作组成一组**，**称作事务**，事务必须满足**ACID，分别是原子性Atomicity，一致性Consistency，隔离性Isolation，以及持久性Durability**

**多个事务并发执行时**，数据库的**并发控制器**必须能够保证多个事务的执行结果不能破坏某种约定，如不能出现事务执行到一半的情况，不能读取到未提交的事务，等等

为了保证持久性，对于数据库的每一个变化都要在磁盘上记录日志，当数据库系统突然发生故障，重启后能够恢复到之前一致的状态



##### 硬件基础

**摩尔定律**告诉我们，每18个月计算机等IT产品的性能会翻一番，或者说相同性能的IT产品，每18个月会降价一半。但是计算机的硬件体系架构相对保持稳定

**架构设计**很重要的一点就是合理的选择屏弃恶能够最大限度地发挥底层硬件的价值



##### cpu架构

早期cpu为**单核芯片**，但是提高单核的速度会产生过多的热量且**无法带来相应的性能改善**  ———— 设计成多核或者多个CPU

经典的多cpu架构为对称多处理结构——SMP ——Symmetric Multi-Precessing，即在一个计算机汇集了一组处理器，**它们之间对称工作，无主次或者从属关系，共享相同的物理内存以及总线**，如图



![](E:\auto\Distribute\large_scale_distributed_system_principles_and_architectures\SMP-system-structure.png)

​	图中的SMP系统由两个CPU构成，每个cpu有两个核心core，cpu与内存之间通过总线通信。每个核心有各自的L1d Cache——L1数据缓存，以及L1i Cache——L1指令缓存，同一个CPU的多个核心共享L2以及L3缓存，另外，某些CPU还可以通过**超线程技术Hyper-Threading Teachnology**使得 一个核心具有同时执行两个线程的能力。

​	SMP**架构的主要特征是共享**，系统中所有资源——CPU,内存,I/O等，都是共享的，由于多CPU**对前端总线的竞争**，SMP的拓展能力非常有限。为了提高拓展性，现在的主流服务器架构一般为NUMA架构——Non-Uniform Memory Access，非一致存储访问架构。它具有多个NUMA节点，每个NUMA节点是一个SMP结构，一般由多个CPU（如4个）组成，并且具有独立的本地内存、I/O槽口等。

​	NUMA节点可以直接快速访问本地内存，也可以通过NUMA**互联互通模块**访问其他NUMA节点的内存，**访问本地内存的速度远远高于远程访问的速度**。因此为了更好的发挥系统的性能，开发应用程序时**需要尽量减少不同NUMA节点之间的信息交互**

##### I/O总线

​	**存储系统的性能瓶颈一般在于IO**，因此有必要对IO子系统的架构有一个大致的了解！

如图：它是典型的南北桥架构。北桥芯片通过前端总线FSB与 CPU相连，内存模块以及PCI-E设备——如高端的SSD设备Fusion-IO，挂接在北桥上。北桥与南桥之间通过DMI连接，DMI的带宽为1GB/s，网卡——包括千兆以及万兆网卡，硬盘以及中低端固态硬盘——inter 320系列SSD，挂接在南桥上。如果采用SATA2接口，那么最大带宽为300MB/s

![](E:\auto\Distribute\large_scale_distributed_system_principles_and_architectures\Inter X48主板南北桥架构.jpg)







##### 网路拓扑

